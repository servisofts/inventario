<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Registrar Múltiples Modelos</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 30px auto; }
    label, input, button { font-size: 16px; }
    label { display: block; margin-top: 20px; font-weight: bold; }
    input[type="text"] { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 25px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .resultado { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; white-space: pre-wrap; }
    .btn-eliminar { cursor: pointer; color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>Registrar Múltiples Modelos</h1>

<form id="formAddDescripcion">
    <label for="descripcion">Descripción</label>
    <input type="text" id="descripcion" name="descripcion" placeholder="Ingrese descripción" required />
    <button type="submit">Agregar a lista</button>
</form>

<table id="tablaModelos" style="display:none;">
    <thead>
        <tr>
            <th>#</th>
            <th>Descripción</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody>
        <!-- Filas se agregan aquí -->
    </tbody>
</table>

<button id="btnSincronizar" style="display:none;">Sincronizar Todos ✅</button>

<div class="resultado" id="resultado"></div>

<script>
    const modelos = [];

    const formAddDescripcion = document.getElementById('formAddDescripcion');
    const tablaModelos = document.getElementById('tablaModelos');
    const tbody = tablaModelos.querySelector('tbody');
    const btnSincronizar = document.getElementById('btnSincronizar');
    const resultado = document.getElementById('resultado');

    function actualizarTabla() {
        tbody.innerHTML = "";
        modelos.forEach((modelo, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${modelo.descripcion}</td>
                <td><span class="btn-eliminar" data-index="${index}">X</span></td>
            `;
            tbody.appendChild(tr);
        });

        tablaModelos.style.display = modelos.length ? 'table' : 'none';
        btnSincronizar.style.display = modelos.length ? 'inline-block' : 'none';

        // Añadir evento a botones eliminar
        tbody.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-index');
                modelos.splice(idx, 1);
                actualizarTabla();
            });
        });
    }

    formAddDescripcion.addEventListener('submit', (e) => {
        e.preventDefault();
        const descripcion = document.getElementById('descripcion').value.trim();
        if (!descripcion) return alert("Por favor ingresa una descripción.");

        modelos.push({ descripcion });
        actualizarTabla();

        formAddDescripcion.reset();
    });

    btnSincronizar.addEventListener('click', () => {
        if (modelos.length === 0) {
            alert("No hay modelos para sincronizar.");
            return;
        }

        resultado.innerText = "Enviando... ⏳";

        // Preparamos array con cada modelo completo
        const payload = modelos.map(m => ({
            key_marca: "9329ba86-0d15-4700-b19a-df879f59c78e",
            precio_venta_moneda: "",
            precio_compra_moneda: "",
            key_tipo_producto: "5e9254f3-5e3b-4379-928d-db593a6e677e",
            descripcion: m.descripcion,
            observacion: null,
            barcode: "123456789",
            precio_compra: 11.11,
            precio_venta: null,
            duracion: null,
            duracion_medida: "",
            cantidad_suscriptores: null,
            codigo_ref: ""
        }));

        // Aquí enviamos uno por uno con await para no saturar (opcional)
        // O enviamos todo en un array si tu API lo soporta (consulta con backend)

        // Vamos a enviar uno por uno para que el backend registre cada modelo
        // Puedes cambiar esto si tu backend acepta array para inserción múltiple

        async function enviarTodos() {
            let resultados = [];
            for (let i = 0; i < payload.length; i++) {
                try {
                    const res = await fetch('http://localhost:30039/rest/modelo/registrar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload[i])
                    });
                    const json = await res.json();
                    resultados.push({ index: i + 1, respuesta: json });
                } catch (error) {
                    resultados.push({ index: i + 1, error: error.message });
                }
            }
            return resultados;
        }

        enviarTodos().then(resultados => {
            resultado.innerText = JSON.stringify(resultados, null, 2);
            modelos.length = 0;
            actualizarTabla();
        });
    });
</script>

</body>
</html>
